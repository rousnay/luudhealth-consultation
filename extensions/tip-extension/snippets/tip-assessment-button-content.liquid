{{ 'stylesheet' | asset_url | stylesheet_tag }}
<script src="{{ 'javascript' | asset_url }}" defer></script>

{% assign section_id = section.id %}
{% assign product_id = product.id %}
{% assign form_id = form.id %}
{% assign treatment_id = block.settings.treatment_id %}

<div class="product-form__input">
  <input
    type="hidden"
    form="product-form-{{ section_id }}-{{ product_id }}"
    id="product-line-item-uuid"
    name="properties[_uuid]"
  >
    <input
    type="hidden"
    form="product-form-{{ section_id }}-{{ product_id }}"
    id="product-treatment-id"
    name="properties[_treatmentId]"
    value="{{treatment_id}}"
  >
</div>

<div class="tip-app-content product-form__assessment-button">
  <button type="button" class="button tip-full-width" id="start-consultancy">START ASSESSMENT</button>
</div>

<script type="text/javascript">
  function getReady(fn) {
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(fn, 1);
      document.removeEventListener('DOMContentLoaded', fn);
    } else {
      document.addEventListener('DOMContentLoaded', fn);
    }
  }

  getReady(function () {
    console.log('Assessment button loaded: V2');

    const product_variants = document.querySelector('.product-form__variants');
    const product_quantity = document.querySelector('.product-form__quantity');
    const product_buy_buttons = document.querySelector('.product-form__buy-buttons');
    const product_assessment_button = document.querySelector('.product-form__assessment-button');
    const product_line_item_uuid = document.getElementById('product-line-item-uuid');
    const product_treatment_id = document.getElementById('product-treatment-id');
    const product_addToCart_button = document.getElementById('AddToCart');

    const the_line_items_uuid = localStorage.getItem('line_items_uuid');

    const treatmentId = product_treatment_id.value;
    localStorage.setItem("treatment_id", treatmentId);
    console.log(treatmentId);

    if (the_line_items_uuid) {
      console.log(the_line_items_uuid);
      product_line_item_uuid.value = the_line_items_uuid;
      product_assessment_button.style.display = 'none';

      product_addToCart_button.addEventListener('click', (e) => {
        localStorage.removeItem('line_items_uuid');
      });
    } else {
      product_variants.style.display = 'none';
      product_quantity.style.display = 'none';
      product_buy_buttons.style.display = 'none';
      product_assessment_button.style.display = 'block';
    }

    const startConsultancy = document.getElementById('start-consultancy');
    startConsultancy.addEventListener('click', (e) => {
      window.location.href = `/pages/consultancy/?treatmentId=${{treatmentId}}`;
    });
  });

  {% comment %} let sectionId = document.querySelector('#shopify-block-{{ block.id }}').closest('section').id;
  console.log(sectionId); {% endcomment %}
</script>
